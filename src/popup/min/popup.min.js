let handleBackToFocus=e=>{let t=eventId(e);setTimeout(()=>{dispatch("memory-container--"+t,"focus")},250)},handleDeleteItem=e=>{e=eventId(e);showConfirmDeleteModal(e)},handleOpenItemLink=e=>{e=eventId(e);focusExistingOrCreateNewPaperTab(global.state.papers[e],!0)},handleOpenItemScirate=e=>{var e=eventId(e),t="https://scirate.com/arxiv/"+arxivIdFromPaperID(global.state.papers[e].id);focusExistingOrCreateNewURLTab(t),global.state.papers[e]=updatePaperVisits(global.state.papers[e]),setStorage("papers",global.state.papers)},handleOpenItemAlphaxiv=e=>{var e=eventId(e),t="https://alphaxiv.org/abs/"+arxivIdFromPaperID(global.state.papers[e].id);focusExistingOrCreateNewURLTab(t),global.state.papers[e]=updatePaperVisits(global.state.papers[e]),setStorage("papers",global.state.papers)},handleOpenItemAr5iv=e=>{let t=eventId(e);e=arxivIdFromPaperID(global.state.papers[t].id);let a="https://ar5iv.labs.arxiv.org/html/"+e;var o=parseInt(e.split(".")[0].slice(-2),10),e=2e3+parseInt(e.split(".")[0].slice(0,2),10),i=(new Date).getMonth()+1;e===(new Date).getFullYear()&&o===i?(showPopupModal("ar5iv"),addListener("ar5iv-modal-ok-button","click",()=>{focusExistingOrCreateNewURLTab(a),global.state.papers[t]=updatePaperVisits(global.state.papers[t]),setStorage("papers",global.state.papers),closePopupModal()}),addListener("ar5iv-modal-cancel-button","click",closePopupModal)):(focusExistingOrCreateNewURLTab(a),global.state.papers[t]=updatePaperVisits(global.state.papers[t]),setStorage("papers",global.state.papers))},handleOpenItemHuggingface=e=>{var e=eventId(e),t="https://huggingface.co/papers/"+arxivIdFromPaperID(global.state.papers[e].id);focusExistingOrCreateNewURLTab(t),global.state.papers[e]=updatePaperVisits(global.state.papers[e]),setStorage("papers",global.state.papers)},handleOpenItemCodeLink=async e=>{e=eventId(e),e=global.state.papers[e].codeLink;await focusExistingOrCreateNewURLTab(e)},handleOpenItemWebsiteURL=async e=>{var e=eventId(e),t=global.state.papers[e].pdfLink;global.state.papers[e]=updatePaperVisits(global.state.papers[e]),await setStorage("papers",global.state.papers),await focusExistingOrCreateNewURLTab(t)},handleCopyMarkdownLink=async e=>{var e=eventId(e),t=global.state.prefs,a=global.state.papers[e],o="website"===a.source?"URL":t.checkPreferPdf?"PDF":"Abstract",a=makeMdLink(a,t);await copyAndConfirmMemoryItem({id:e,textToCopy:a,feedbackText:`Markdown ${o} link copied!`,context:global.state.memoryIsOpen?"memory":"popup"})},handleCopyBibtex=async e=>{var e=eventId(e),t=global.state.papers[e].bibtex,t=bibtexToObject(t);t.hasOwnProperty("url")||(t.url=paperToAbs(global.state.papers[e])),t.hasOwnProperty("pdf")||"website"===global.state.papers[e].source||(t.pdf=paperToPDF(global.state.papers[e])),await copyAndConfirmMemoryItem({id:e,textToCopy:bibtexToString(t),feedbackText:"Bibtex copied!",context:global.state.memoryIsOpen?"memory":"popup"})},handleCopyPDFLink=async e=>{var e=eventId(e),t=global.state.prefs,a=global.state.papers[e],o=(t.checkPreferPdf?paperToPDF:paperToAbs)(a),a="website"===a.source?"URL":t.checkPreferPdf?"PDF":"Abstract";await copyAndConfirmMemoryItem({id:e,textToCopy:o,feedbackText:a+" link copied!",context:global.state.memoryIsOpen?"memory":"popup"})},handleCopyHyperLink=async e=>{var e=eventId(e),t=global.state.prefs,a=global.state.papers[e],t=(t.checkPreferPdf?paperToPDF:paperToAbs)(a);await copyAndConfirmMemoryItem({id:e,textToCopy:t,feedbackText:"Hyperlink copied!",hyperLinkTitle:a.title,context:global.state.memoryIsOpen?"memory":"popup"})},handleAddItemToFavorites=e=>{var e=eventId(e),t=hasClass("memory-container--"+e,"favorite");saveFavoriteItem(e,!t)},handleMemoryOpenLocal=e=>{var e=eventId(e),t=global.state.files[e],a=global.state.papers[e];global.state.papers[e]=updatePaperVisits(a),setStorage("papers",global.state.papers),t&&(t.id||0===t.id)&&chrome.downloads.open(t.id),window?.close&&window.close()},handleTextareaFocus=()=>{textareaFocusEnd(this)},handleMemorySaveEdits=e=>{var{note:t,codeLink:a}=getPaperEdits(e);saveNote(e,t),saveCodeLink(e,a),updatePaperTags(e,"memory-item-tags")},handleCancelPaperEdit=e=>{e.preventDefault();var e=eventId(e),t=global.state.papers[e];val(findEl({paperId:e,memoryItemClass:"form-note-textarea"}),t.note),setHTML(findEl({paperId:e,memoryItemClass:"memory-item-tags"}),getTagsOptions(t)),dispatch(findEl({paperId:e,memoryItemClass:"memory-item-edit"}),"click")},handleTogglePaperEdit=e=>{e.preventDefault();var e=eventId(e),t=findEl({element:"memory-container--"+e}),a=findEl({paperId:e,memoryItemClass:"code-and-note"}),o=findEl({paperId:e,memoryItemClass:"extended-item"}),i=findEl({paperId:e,memoryItemClass:"tag-list"}),r=findEl({paperId:e,memoryItemClass:"memory-authors"}),s=findEl({paperId:e,memoryItemClass:"edit-tags"}),l=findEl({paperId:e,memoryItemClass:"memory-item-actions"});let n=$(findEl({paperId:e,memoryItemClass:"memory-item-tags"}));hasClass(t,"expand-open")?(removeClass(t,"expand-open"),slideDown(a,150),slideDown(i,150),slideDown(l,150),slideDown(r,150),slideUp(o,150),slideUp(s,150),setTimeout(()=>{n.select2("destroy")},500)):(addClass(t,"expand-open"),n.select2({...global.select2Options,width:"86%"}),hasClass(t,"has-monitoring")||n.on("change",monitorPaperEdits(e,!1)),t.classList.add("has-monitoring"),slideUp(a,150),slideUp(i,150),slideUp(l,150),slideUp(r,150),slideDown(o,150),slideDown(s,150))},handleMemorySelectChange=e=>{e=e.target.value,global.state.sortKey=e,sortMemory(),e=null!==document.getElementById("papers-table-body");(e?displayMemoryTableView:displayMemoryTable)(),setMemorySortArrow("down")},handleMemorySortArrow=e=>{var t=document.getElementById("memory-sort-toggle"),a=document.querySelector("#memory-sort-arrow svg"),o=(t?(o=t.classList.contains("desc"),t=t.classList.contains("asc"),o||!o&&!t?setMemorySortArrow("up"):setMemorySortArrow("down")):a&&("memory-sort-arrow-down"===a.id?setMemorySortArrow("up"):setMemorySortArrow("down")),reverseMemory(),null!==document.getElementById("papers-table-body"));(o?displayMemoryTableView:displayMemoryTable)()},handleFilterFavorites=()=>{var e=!global.state.showFavorites,t=(global.state.showFavorites=e,findEl({element:"filter-favorites"}));e?((e=t.querySelector("svg"))?addClass(e,"favorite"):addClass(t,"active"),sortMemory(),global.state.papersList=global.state.papersList.filter(e=>e.favorite),(null!==document.getElementById("papers-table-body")?displayMemoryTableView:displayMemoryTable)(),setMemorySortArrow("down"),findEl("memory-select").innerHTML+='<option value="favoriteDate">Last favoured</option>',e=global.state.papersList.length,setPlaceholder("memory-search",`Search ${e} entries...`)):((e=t.querySelector("svg"))?removeClass(e,"favorite"):removeClass(t,"active"),"favoriteDate"===val("memory-select")&&(val("memory-select","lastOpenDate"),global.state.sortKey="lastOpenDate"),(e=querySelector('#memory-select option[value="favoriteDate"]'))&&e.remove(),global.state.papersList=global.state.sortedPapers,sortMemory(),setMemorySortArrow("down"),(null!==document.getElementById("papers-table-body")?displayMemoryTableView:displayMemoryTable)(),val("memory-search").trim()&&dispatch("memory-search","keypress"),t=global.state.sortedPapers.length,setPlaceholder("memory-search",`Search ${t} entries...`))},handleMemorySearchKeyPress=o=>e=>{var t=val("memory-search").trim();if(log(t),t||setTimeout(()=>{var e=document.getElementById("memory-search-clear")||document.getElementById("memory-search-clear-icon");e&&(e.style.visibility="hidden")},0),!t){if(global.state.papersList.length!==global.state.sortedPapers.length){global.state.papersList=global.state.sortedPapers;let e=null!==document.getElementById("papers-table-body");return void(e?displayMemoryTableView:displayMemoryTable)()}if(!o&&"Backspace"!==e.key)return}e=document.getElementById("memory-search-clear")||document.getElementById("memory-search-clear-icon");e&&(e.style.visibility="visible"),(t.startsWith("t:")?searchMemoryByTags:t.startsWith("c:")?searchMemoryByCode:t.startsWith("y:")?searchMemoryByYear:searchMemory)(t),toggleTagsCollapse(t.startsWith("t:"));let a=null!==document.getElementById("papers-table-body");(a?displayMemoryTableView:displayMemoryTable)()},handleMemorySearchKeyUp=e=>{var t;"Backspace"==e.key&&((t=new Event("keypress")).key="Backspace",dispatch("memory-search",t)),"memory-search"===e.target.id&&dispatch("memory-search","keypress")},handleCancelModalClick=()=>{hideId("delete-paper-modal")},handleConfirmDeleteModalClick=async e=>{var t=findEl({element:"delete-paper-modal-hidden-id"}).innerHTML,a=global.state.papers[t].title,o=global.state.papers[t].pdfLink;await deletePaperInStorage(t,global.state.papers),displayMemoryTable(),hideId("delete-paper-modal"),info(`Successfully deleted "${a}" (${t}) from PaperMemory`),global.state.currentId===t&&await updatePopupPaperNoMemory(o),setPlaceholder("memory-search",`Search ${global.state.papersList.length} entries ...`),addListener("memory-switch","click",handleMemorySwitchClick)},handleTagClick=e=>{e=e.target.textContent;val("memory-search","t: "+e),dispatch("memory-search","keypress")},handleClearSearch=e=>{val("memory-search",""),dispatch("memory-search","clear-search");var t=document.getElementById("memory-search-clear")||document.getElementById("memory-search-clear-icon");t&&(t.style.visibility="hidden")},handleMemorySwitchClick=()=>{(global.state.memoryIsOpen?closeMemory:openMemory)()},handlePopupKeydown=async a=>{let o=a.key;var i=a.ctrlKey||a.metaKey,r="Enter"===o&&!i,s="Enter"===o&&i;if((!i||s)&&!(["Backspace","Enter","Escape","a","e","o","c","m","b","h","p","t","d","5","f","x","s"].indexOf(o)<0))if(global.state.modalIsOpen)"Escape"===o&&(a.preventDefault(),closePopupModal());else if(global.state.prefsIsOpen)"Escape"===o?(a.preventDefault(),closeMenu()):"Enter"===o&&querySelector("#menu-switch:focus")&&closeMenu();else{if(s&&eventId(a)){let e=eventId(a);i=findEl({paperId:e,memoryItemClass:"extended-item"}),s="none"!==i.style.display,i=i.querySelector(".cancel-note-form");i&&s&&i.click()}s=queryAll(":focus").some(e=>["INPUT","TEXTAREA"].includes(e.tagName));if(!s||"Escape"===o)if("Escape"===o&&global.state.tooltipIsOpen)handleHideAllTitleTooltips(a),a.preventDefault();else{if(!global.state.memoryIsOpen)if("a"===o)global.state.papers&&dispatch("memory-switch","click");else if("Enter"===o){i=querySelector(":focus");if("memory-switch-open"===i?.id)return dispatch("memory-switch","click");if("menu-switch"===i?.id)return dispatch("menu-switch","click"),dispatch("menu-switch","blur");if(hasClass(i,"memory-item-svg-div"))return dispatch(i,"click")}else if("p"===o&&!global.state.prefsIsOpen)return dispatch("menu-switch","click");if(r){if(querySelector("#filter-favorites:focus"))return dispatch("filter-favorites","click");if(querySelector("#memory-sort-arrow:focus"))return dispatch("memory-sort-arrow","click")}let e,t;if(global.state.currentId&&!global.state.memoryIsOpen)e=global.state.currentId;else if(t=querySelector(".memory-container:focus"),"Escape"!==o){if(!t)return;e=t.id.split("--")[1]}s=({id:e,memoryItemClass:t,paperItem:a})=>a?findEl({paperId:e,memoryItemClass:t}):findEl({element:`popup-${t}--`+e});"Backspace"===(o=r?await getDefaultKeyboardAction():o)?dispatch(s({id:e,paperItem:t,memoryItemClass:"memory-delete"}),"click"):"o"===o?(i="website"===global.state.papers[e].source?s({id:e,paperItem:t,memoryItemClass:"memory-website-url"}):global.state.prefs.checkEnterLocalPdf&&s({id:e,paperItem:t,memoryItemClass:"memory-item-openLocal"})||s({id:e,paperItem:t,memoryItemClass:"memory-item-link"}),dispatch(i,"click")):"Escape"===o?t&&hasClass(t,"expand-open")?(a.preventDefault(),handleTogglePaperEdit(a)):global.state.memoryIsOpen&&(a.preventDefault(),closeMemory()):"e"===o?dispatch(s({id:e,paperItem:t,memoryItemClass:"memory-item-edit"}),"click"):"c"===o?dispatch(s({id:e,paperItem:t,memoryItemClass:"memory-item-copy-link"}),"click"):"m"===o?dispatch(s({id:e,paperItem:t,memoryItemClass:"memory-item-md"}),"click"):"b"===o?dispatch(s({id:e,paperItem:t,memoryItemClass:"memory-item-bibtex"}),"click"):"5"===o?dispatch(s({id:e,paperItem:t,memoryItemClass:"memory-item-ar5iv"}),"click"):"x"===o?dispatch(s({id:e,paperItem:t,memoryItemClass:"memory-item-alphaxiv"}),"click"):"f"===o?dispatch(s({id:e,paperItem:t,memoryItemClass:"memory-item-huggingface"}),"click"):"s"===o?dispatch(s({id:e,paperItem:t,memoryItemClass:"memory-item-scirate"}),"click"):"h"===o?dispatch(s({id:e,paperItem:t,memoryItemClass:"memory-item-copy-hyperlink"}),"click"):"t"===o?(r=global.state.papers[e].title,await copyAndConfirmMemoryItem({id:e,textToCopy:r,feedbackText:"Title copied!",context:Boolean(t)?"memory":"popup"})):"d"===o&&dispatch(s({id:e,paperItem:t,memoryItemClass:"memory-display-id"}),"click")}}},handlePrefsCheckChange=async e=>{let t=e.target.id,a=findEl({element:t}).checked;global.state&&global.state.prefs?(global.state.prefs[t]=a,setStorage("prefs",global.state.prefs,function(){log(`Settings saved for ${t} (${a})`)})):((e=await getStorage("prefs")??{})[t]=a,setStorage("prefs",e,function(){log(`Settings saved for ${t} (${a})`)})),a&&"checkNoAuto"===t&&chrome.commands.getAll(e=>{e=e.find(e=>"manualParsing"===e.name).shortcut;console.log("shortcut: ",e),e||showPopupModal("manualParsing")})},handlePopupSaveEdits=e=>{var{note:t,codeLink:a,favorite:o}=getPaperEdits(e,!0);updatePaperTags(e,"#popup-item-tags--"+e),saveNote(e,t),saveCodeLink(e,a),saveFavoriteItem(e,o)},handlePopupDeletePaper=e=>()=>{showConfirmDeleteModal(e)},showTitleTooltip=(e,t)=>{t=t?findEl({element:"popup-title-tooltip"}):findEl({paperId:e,memoryItemClass:".title-tooltip"});t&&(hideAllTooltips(),global.state.tooltipIsOpen=!0,showId(t))},hideTitleTooltip=(e,t)=>{t=t?findEl({element:"popup-title-tooltip"}):findEl({paperId:e,memoryItemClass:".title-tooltip"});t&&(hideId(t),global.state.tooltipIsOpen=!1)},getHandleTitleTooltip=(o,i,r)=>e=>{let t=r?global.state.currentId:eventId(e);var a=global.state.timerIdMap.get(e.target)??0;clearTimeout(a),a=setTimeout(()=>o(t,r),i),global.state.timerIdMap.set(e.target,a)},handleExpandAuthors=e=>{let t,a;a="popup-authors"===e.target.parentElement?.id?(t=global.state.currentId,findEl({element:"popup-authors"})):(t=eventId(e),findEl({paperId:t,memoryItemClass:"memory-authors"})),setHTML(a,cutAuthors(global.state.papers[t].author,1e5))},handleHideAllTitleTooltips=e=>{e.composedPath().some(e=>e.classList?.contains("title-tooltip"))||hideAllTooltips()},getPaperInfoTable=e=>{var t=[["Added",new Date(e.addDate).toLocaleString().replace(",","")],["Last open",new Date(e.lastOpenDate).toLocaleString().replace(",","")],["Visits",e.count],["Source",global.knownPaperPages[e.source].name]];return e.venue&&t.push(["Publication",`<strong>${e.venue} ${e.year}</strong>`]),`
        <table class="paper-info-table">
            ${t.map(e=>`
                        <tr>
                            <td><div class="info-table-key">${e[0]}</div></td>
                            <td><div class="info-table-value">${e[1]}</div></td>
                        </tr>
                    `).join("")}
        </table>
    `},getMemoryItemHTML=e=>{var t=getDisplayId(e.id),a=e.note||"",o=e.id,i=new Set(e.tags),r=getTagsOptions(e),s=e.favorite?"favorite":"",l={...global.svgActionsHoverTitles},n=(l.pdfLink="Open tab to "+e.title,l.copyLink="Copy URL to the paper's "+(global.state.prefs.checkPreferPdf?"PDF":"abstract"),l.displayId="Click to see metadata",`
        <small class="memory-item-faded">

            <div class="memory-code-link"> ${e.codeLink.replace(/^https?:\/\//,"")||""} </div>
            <div class="memory-website-url">
                ${"website"==e.source&&e.pdfLink.replace(/^https?:\/\//,"")||""}
            </div>
        </small>
    `);let d='<div class="memory-note-div memory-item-faded"></div>';e.note&&(d=`
            <div class="memory-note-div memory-item-faded">
                <span class="note-content-header">Note:</span>
                <span class="note-content">${a}</span>
            </div>
        `);var p=global.state.files.hasOwnProperty(e.id)?`
            <div
                class="memory-item-openLocal memory-item-svg-div"
                title='${l.openLocal}'
            >
                ${tablerSvg("vocabulary","",["memory-icon-svg"])}
            </div>`:"",c="website"===e.source?"":`
            <div
                class="memory-item-link memory-item-svg-div"
                title='${l.pdfLink}'
            >
                ${tablerSvg("external-link","",["memory-icon-svg"])}
            </div>`;let m="",u=(global.state.prefs.checkScirate&&"arxiv"===e.source&&(m=`
        <div
            class="memory-item-scirate memory-item-svg-div"
            title="Open on SciRate"
        >
            ${tablerSvg("messages","",["memory-icon-svg"])}
        </div>`),""),g=(global.state.prefs.checkAlphaxiv&&"arxiv"===e.source&&(u=`
        <div
            class="memory-item-alphaxiv memory-item-svg-div"
            title="Open on AlphaXiv"
        >
            ${tablerSvg("alphaxiv","",["memory-icon-svg","alphaxiv-icon"])}
        </div>`),""),h=(global.state.prefs.checkAr5iv&&"arxiv"===e.source&&(g=`
        <div
            class="memory-item-ar5iv memory-item-svg-div"
            title="Open on ar5iv"
        >
            ${tablerSvg("ar5iv","",["memory-icon-svg"])}
        </div>`),"");global.state.prefs.checkHuggingface&&"arxiv"===e.source&&(h=`
        <div
            class="memory-item-huggingface memory-item-svg-div"
            title="Open on HuggingFace Papers"
        >
            ${tablerSvg("huggingface","",["memory-icon-svg"])}
        </div>`);var y=getPaperInfoTable(e);return`
        <div
            class="memory-container ${s}"
            tabindex="0"
            id="memory-container--${o}"
        >
            <h4 class="memory-title">
                <span class="memory-item-favorite">
                    ${tablerSvg("star","",["memory-item-favorite-svg",s])}
                </span>
                ${e.title}
                <div class="title-tooltip" style="display: none;">
                    ${y}
                </div>
            </h4>
            <div class="my-1 mx-0">
                <small class="tag-list">
                    ${[...i].map(e=>`<span class="memory-tag" >${e}</span>`).join("")}
                </small>
                <div class="edit-tags p-0" style="display: none">
                    <div class="flex-center-between">
                        <span class="label">Tags:</span>
                        <select
                            class="memory-item-tags"
                            id="memory-item-tags--${o}"
                            multiple="multiple"
                        >
                            ${r}
                        </select>
                    </div>
                </div>
            </div>
            <small class="memory-authors">${cutAuthors(e.author)}</small>

            <div class="code-and-note">${n} ${d}</div>

            <div class="memory-item-actions flex-center-between mt-2">
                <div class="d-flex align-items-center">
                    <div
                        class="memory-item-edit memory-item-svg-div me-2"
                        title='${l.edit}'
                    >
                        ${tablerSvg("writing","",["memory-icon-svg"])}
                    </div>

                    <small class="memory-item-faded memory-display-id" title='${l.displayId}'>
                        ${t}
                    </small>
                </div>

                ${p}
                ${c}
                ${h}
                ${u}
                ${g}
                ${m}


                <div
                    class="memory-item-copy-link memory-item-svg-div"
                    title='${l.copyLink}'
                >
                    ${tablerSvg("link","",["memory-icon-svg"])}
                </div>

                <div
                    class="memory-item-copy-hyperlink memory-item-svg-div"
                    title='${l.copyHypeLink}'
                >
                    ${tablerSvg("device-desktop-code","",["memory-icon-svg"])}
                </div>



                <div class="memory-item-md memory-item-svg-div" title='${l.copyMd}'>
                    ${tablerSvg("markdown","",["memory-icon-svg"])}
                </div>

                <div
                    class="memory-item-bibtex memory-item-svg-div"
                    title='${l.copyBibtext}'
                >
                    ${tablerSvg("math-function","",["memory-icon-svg"])}
                </div>

                <span style="display: none" class="memory-item-feedback"></span>

            </div>

            <div class="extended-item" style="display: none">
                <div class="item-note">
                    <form class="form-note">
                        <div class="flex-center-start">
                            <span class="label">Code:</span>
                            <input
                                type="text"
                                class="form-code-input"
                                value="${e.codeLink||""}"
                                placeholder="Add link"
                            />
                        </div>
                        <div class="flex-center-start">
                            <span class="label">Note:</span>
                            <textarea
                                rows="2"
                                class="form-note-textarea"
                                placeholder="Anything to note?"
                            >
${a}</textarea
                            >
                        </div>
                        <div class="form-note-buttons">
                            <button class="cancel-note-form back-to-focus">
                                Done
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="memory-delete" title="Delete from Memory">-</div>
        </div>
    `},getPopupEditFormHTML=e=>{var t=e.id,a=getTagsOptions(e),o=e.note||"",i=getDisplayId(e.id);return` <div
        style="max-width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 4px 16px;"
    >
        <div style="width: 100%">
            <div
                style="width: 100%; display: flex; justify-content: space-between; align-items: center;"
            >
                <span class="label">Tags:</span>
                <select
                    id="popup-item-tags--${t}"
                    class="memory-item-tags"
                    multiple="multiple"
                >
                    ${a}
                </select>
            </div>
            <div
                class="form-note"
                id="popup-form-note--${t}"
                style="width: 100%; display: flex; justify-content: space-between; align-items: center; margin-top: 8px; flex-direction: column;"
            >
                <div class="flex-center-start w-100 mr-0">
                    <span class="label">Code:</span>
                    <input
                        id="popup-form-codeLink--${t}"
                        type="text"
                        class="form-code-input mt-0"
                        value="${e.codeLink||""}"
                        placeholder="Add code link"
                    />
                </div>
                <div class="flex-center-start w-100 mr-0">
                    <span class="label">Note:</span>
                    <textarea
                        rows="2"
                        class="popup-form-note-textarea"
                        id="popup-form-note-textarea--${t}"
                        placeholder="Anything to note?"
                    >
${o}</textarea
                    >
                </div>
            </div>
            <div
                style="display: flex; justify-content: space-between; align-items: center"
            >
                <div
                    style="display: flex; justify-content: flex-start; align-items: center"
                >
                    <label class="label" for="checkFavorite">Favorite: </label>
                    <input
                        ${""}
                        class="switch"
                        type="checkbox"
                        id="checkFavorite--${t}"
                        name="checkFavorite"
                        value="checkFavorite"
                    />
                </div>
                <div id="popup-delete-paper" title="Delete paper from Memory">
                    <svg
                        width="25"
                        height="25"
                        viewBox="0 0 24 24"
                        stroke-width="1"
                        fill="none"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke="white"
                    >
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <line x1="4" y1="7" x2="20" y2="7" />
                        <line x1="10" y1="11" x2="10" y2="17" />
                        <line x1="14" y1="11" x2="14" y2="17" />
                        <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                        <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                    </svg>
                </div>
                <small class="popup-display-id" id="popup-memory-display-id--${t}"> ${i} </small>
                <button
                    hidden
                    class="back-to-focus"
                    id="popup-save-edits--${t}"
                >
                    Save
                </button>
            </div>
        </div>
    </div>`},getPopupPaperIconsHTML=(e,t,a)=>{var o=e.id,i=isPdfUrl(t)?"HTML":"PDF";let r="",s=(global.state.prefs.checkScirate&&"arxiv"===e.source&&(r=`
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-scirate--${o}"
            title="Open on SciRate"
        >
            ${tablerSvg("messages","",["popup-click-svg"])}
        </div>`),""),l=(global.state.prefs.checkAlphaxiv&&"arxiv"===e.source&&!t.includes("alphaxiv.org")&&(s=`
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-alphaxiv--${o}"
            title="Open on AlphaXiv"
        >
            ${tablerSvg("alphaxiv","",["popup-click-svg","alphaxiv-icon"])}
        </div>`),""),n=(global.state.prefs.checkAr5iv&&"arxiv"===e.source&&!t.includes("ar5iv.labs.arxiv.org")&&(l=`
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-ar5iv--${o}"
            title="Open on ar5iv"
        >
            ${tablerSvg("ar5iv","",["popup-click-svg"])}
        </div>`),"");global.state.prefs.checkHuggingface&&"arxiv"===e.source&&!t.includes("huggingface.co/papers/")&&(n=`
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-huggingface--${o}"
            title="Open on HuggingFace Papers"
        >
            ${tablerSvg("huggingface","",["popup-click-svg"])}
        </div>`);t=global.state.prefs.checkStore&&(a.localFile||a.stored||global.state.files.hasOwnProperty(e.id))?`
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-openLocal--${o}"
            title="Open downloaded pdf"
        >
            ${tablerSvg("vocabulary","",["popup-click-svg"])}
        </div>
        `:`
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-download--${o}"
            title="Download pdf"
        >
            ${tablerSvg("file-download","",["popup-click-svg"])}
        </div>
    `;return`
        ${"website"===e.source?"":`<div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-link--${o}"
            title="Open Paper ${i} Page"
        >
            ${tablerSvg("external-link","",["popup-click-svg"])}
        </div>`}
        ${n}
        ${r}
        ${s}
        ${l}

        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-copy-link--${o}"
            title="Copy link to paper"
        >
            ${tablerSvg("link","",["popup-click-svg"])}
        </div>
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-copy-hyperlink--${o}"
            title="Copy hyperlink to paper"
        >
            ${tablerSvg("device-desktop-code","",["popup-click-svg"])}
        </div>

        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-md--${o}"
            title="Copy Markdown-formatted link"
        >
            ${tablerSvg("markdown","",["popup-click-svg"])}
        </div>

        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-bibtex--${o}"
            title="Copy Bibtex citation"
        >
            ${tablerSvg("math-function","",["popup-click-svg"])}
        </div>
        
        <div
            tabindex="0"
            class="memory-item-svg-div"
            id="popup-memory-item-anki--${o}"
            title="Add to Anki (Ctrl+K)"
        >
            ${tablerSvg("clipboard-list","",["popup-click-svg"])}
        </div>

        `+t},getMemoryTableRowHTML=e=>{var t=e.id,a=(getDisplayId(e.id),e.note||""),o=new Set(e.tags),i=e.favorite?"active":"",r=e.venue||e.journal||e.booktitle||"",s=e.year||"",l=(e,t)=>e.length<=t?e:e.substring(0,t)+"...",n=l(e.title,80),d=l(cutAuthors(e.author,100),50),p=l(r,20);l(a,60),[...o].slice(0,3).map(e=>`<span class="tag-badge" data-tag="${e}">${e}</span>`).join(""),3<o.size&&o.size;return`
        <tr class="paper-row" data-paper-id="${t}">
            <td class="col-favorite">
                <span class="favorite-star ${i}" data-paper-id="${t}" title="Toggle favorite">
                    &nbsp;
                </span>
            </td>
            <td class="col-title">
                <div class="paper-title" data-paper-id="${t}" title="${e.title}">
                    ${n}
                </div>
            </td>
            <td class="col-authors">
                <div class="paper-authors" title="${cutAuthors(e.author)}">
                    ${d}
                </div>
            </td>
            <td class="col-venue">
                <div class="paper-venue" title="${r}">
                    ${p}
                </div>
            </td>
            <td class="col-year">
                <div class="paper-year">
                    ${s}
                </div>
            </td>
            <td class="col-tags">
                <div class="paper-tags" data-paper-id="${t}">
                    <input type="text" class="editable-tags" 
                           value="${[...o].join(", ")}" 
                           data-paper-id="${t}"
                           data-original-value="${[...o].join(", ")}"
                           placeholder="Add tags..." 
                           title="Click to edit tags">
                </div>
            </td>
            <td class="col-note">
                <div class="paper-note" data-paper-id="${t}">
                    <textarea class="editable-note" 
                              data-paper-id="${t}"
                              data-original-value="${a}"
                              placeholder="Add note..."
                              rows="2"
                              title="Click to edit note">${a}</textarea>
                </div>
            </td>
            <td class="col-actions">
                <div class="action-buttons">
                    <button class="action-btn copy-md" 
                            data-paper-id="${t}" 
                            title="Copy Markdown link">
                        MD
                    </button>
                    <button class="action-btn copy-bibtex" 
                            data-paper-id="${t}" 
                            title="Copy BibTeX citation">
                        BIB
                    </button>
                    <button class="action-btn open-paper" 
                            data-paper-id="${t}" 
                            title="Open paper">
                        OPEN
                    </button>
                </div>
            </td>
        </tr>
    `},getTagsOptions=e=>{let o=new Set(e.tags);return[...global.state.paperTags].sort().map((e,t)=>{let a='<option value="'+e+'"';return o.has(e)&&(a+=' selected="selected" '),a+`>${e}</option>`}).join("")},toggleTagsCollapse=e=>{e?findEl({element:"tags-list-container"})||(e=`
            <div id="tags-list-container">
                <details id="tags-list-details" style="outline: none !important;">
                    <summary style="font-size: 0.85rem; color: #5f5f5f;">Tags list</summary>
                    ${`
            <ul id="all-tags-list">
                ${[...global.state.paperTags].map(e=>`<li class="memory-tag" >${e}</li>`).join("")}
            </ul>`}
                </details>
            </div>`,findEl({element:"memory-filters"}).insertAdjacentHTML("afterend",e)):findEl({element:"tags-list-container"})?.remove()},updateAllMemoryPaperTagOptions=()=>{for(var e in global.state.papers){var t;global.state.papers.hasOwnProperty(e)&&"__dataVersion"!==e&&(t=global.state.papers[e],setHTML("memory-item-tags--"+e,getTagsOptions(t)))}},sampleAsciiArt=async()=>{var e=chrome.runtime.getURL("src/data/art.json"),e=await fetch(e).then(e=>e.json()),t=Object.keys(e).length,t=Math.floor(Math.random()*t),[e,t]=Object.entries(e)[t];return{animal:e,ascii:t}},updatePopupPaperNoMemory=async o=>{var{animal:e,ascii:t}=await sampleAsciiArt();let a=`
        <div class="no-paper-div">
            <h3>This paper is not in your Memory&nbsp;
            <span id="no-paper-why-span">
                <button class="code-font" id="no-paper-why-code">?</button>
            </span>
            </h3>
            <div>
                <div>Here's a ${e} for your trouble</div><br>
                <div id="ascii-art-div"><div style="text-align:">${t}</div></div>
            </div>
        </div>
    `;e=-1<navigator.userAgent.search("Firefox"),t=e||global.state.prefs.checkNoAuto;let i=e?`
            <div id="ff-warning">
                Firefox does not support content scripts on PDFs.<br/>
                Use the button below to parse this paper.<br/>
            </div>
        `:"",r=(t&&(a+=`
            <div id="manual-trigger-wrapper">
                ${i}
                <div id="manual-trigger-btn">Try manual trigger</div>
                <div id="manual-loader-container" class="pm-container" style='display: none;'>
                    <div class="sk-folding-cube">
                        <div class="sk-cube1 sk-cube"></div>
                        <div class="sk-cube2 sk-cube"></div>
                        <div class="sk-cube4 sk-cube"></div>
                        <div class="sk-cube3 sk-cube"></div>
                    </div>
                </div>
                <div id="manual-parsing-error"></div>
            </div>
        `),findEl({element:"isArxiv"}).innerHTML);setHTML("isArxiv",a),addListener("no-paper-why-code","click",()=>{showPopupModal("noPaper")}),t&&addListener("manual-trigger-btn","click",async()=>{showId("manual-loader-container");try{var t=await isPaper(o);let e;var a=await addOrUpdatePaper({url:o,is:t});a&&(e=a.paper)&&(hideId("manual-loader-container"),setHTML("isArxiv",r),popupMain(o,t,!0))}catch(e){hideId("manual-loader-container"),setHTML("manual-parsing-error",`<strong>${"There was an issue parsing this paper. <br/> Raise an issue on Github if you think it is a bug.<br/>Attempted url: "+o}</strong>`),warn("Manual Parsing Error:",e)}})},showConfirmDeleteModal=e=>{var t=global.state.papers[e].title;setTextId("delete-modal-title",t),setHTML("delete-paper-modal-hidden-id",e),showId("delete-paper-modal","flex")},copyAndConfirmMemoryItem=async({id:e,textToCopy:t,feedbackText:a,context:o="popup",hyperLinkTitle:i=null})=>{i?await copyHyperLinkToClipboard(t,i):copyTextToClipboard(t);let r="popup"===o?findEl({element:"popup-feedback-copied"}):"memory"===o?findEl({paperId:e,memoryItemClass:"memory-item-feedback"}):null;r&&(r.innerText=a,fadeIn(r),setTimeout(()=>{fadeOut(r)},2e3))},focusExistingOrCreateNewURLTab=t=>new Promise(i=>{if((t=t.replace("http://","https://")).startsWith("https://")||(t="https://"+t),!chrome.tabs)return window?.location?.href&&(window.location.href=t),i();var e=new URL(t).origin;chrome.tabs.query({url:e+"/*"},e=>{for(let o of e)if(o.url.includes(t)){let t={active:!0},a={focused:!0};return chrome.windows.getCurrent(e=>{e.id!==o.windowId?chrome.windows.update(o.windowId,a,()=>{chrome.tabs.update(o.id,t),i()}):(chrome.tabs.update(o.id,t),i())}),void i()}chrome.tabs.create({url:t}),i()}),i()}),focusExistingOrCreateNewPaperTab=async(s,l)=>{chrome.tabs?chrome.tabs.query({},async e=>{var t,a=global.state.prefs,o=[];for(t of e){let e;try{e=t.url&&await parseIdFromUrl(t.url)}catch(e){}e&&e===s.id&&o.push(t)}let i;var r,e=a.checkPreferPdf?o.filter(e=>e.url&&isPdfUrl(e.url)):o.filter(e=>e.url&&!isPdfUrl(e.url));0<e.length?(r=l&&global.state.files.hasOwnProperty(s.id)?[]:o.filter(e=>e.url.startsWith("file://")),i=(0<r.length?r:e)[0]):0<o.length&&(i=o[0]),i?chrome.windows.getCurrent(e=>{e.id!==i.windowId?chrome.windows.update(i.windowId,{focused:!0},()=>{chrome.tabs.update(i.id,{active:!0})}):chrome.tabs.update(i.id,{active:!0})}):global.state.files.hasOwnProperty(s.id)&&!l?chrome.downloads.open(global.state.files[s.id].id):chrome.tabs.create({url:(a.checkPreferPdf?paperToPDF:paperToAbs)(s)}),global.state.papers[s.id]=updatePaperVisits(global.state.papers[s.id]),chrome.storage.local.set({papers:global.state.papers})}):focusExistingOrCreateNewURLTab((isPdfUrl(window.location.href)?paperToAbs:paperToPDF)(s))},saveNote=(t,a)=>{global.state.papers[t].note=a,chrome.storage.local.set({papers:global.state.papers},()=>{setHTML(findEl({paperId:t,memoryItemClass:"memory-note-div"}),a?` <div class="memory-note-div memory-item-faded">
                      <span class="note-content-header">Note:</span>
                      <span class="note-content">${a}</span>
                  </div>`:'<div class="memory-note-div memory-item-faded"></div>');var e=findEl({element:"popup-form-note-textarea--"+t});val(e,a),val(findEl({paperId:t,memoryItemClass:"form-note-textarea"}),a)})},saveCodeLink=(t,a)=>{a=a.trim(),global.state.papers[t].codeLink=a,chrome.storage.local.set({papers:global.state.papers},()=>{var e=a.replace(/^https?:\/\//,""),e=(setHTML(findEl({paperId:t,memoryItemClass:"memory-code-link"}),e),setHTML("popup-code-link",e),val(findEl({paperId:t,memoryItemClass:"form-code-input"}),a),(a?showId:hideId)("popup-code-link"),findEl({element:"popup-form-codeLink--"+t}));val(e,a)})},saveFavoriteItem=(a,o)=>{global.state.papers[a].favorite=o,global.state.papers[a].favoriteDate=(new Date).toJSON(),chrome.storage.local.set({papers:global.state.papers},()=>{(o?(addClass("memory-container--"+a,"favorite"),addClass):(removeClass("memory-container--"+a,"favorite"),removeClass))(findEl({paperId:a,memoryItemClass:"memory-item-favorite"}).querySelector("svg"),"favorite"),"favoriteDate"===global.state.sortKey&&(o||(sortMemory(),displayMemoryTable()),e=global.state.sortedPapers.filter(e=>e.favorite).length,t=findEl({element:"memory-search"}))&&setPlaceholder(t,`Search ${e} entries`);var e,t=findEl({element:"checkFavorite--"+a});t&&(t.checked=o)})},setMemorySortArrow=t=>{var e=document.getElementById("memory-sort-arrow")||document.getElementById("memory-sort-toggle");if(e)if("memory-sort-toggle"===e.id){var a=e.querySelector(".sort-arrow");a&&(e.classList.remove("asc","desc"),"up"===t?(e.classList.add("asc"),a.innerHTML="↑"):(e.classList.add("desc"),a.innerHTML="↓"))}else{let e;e="up"===t?`<svg
                viewBox="0 0 24 24"
                class="memory-sort-arrow-svg"
                id="memory-sort-arrow-up"
            >
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="16" y1="9" x2="12" y2="5" />
                <line x1="8" y1="9" x2="12" y2="5" />
            </svg>`:`<svg
                class="memory-sort-arrow-svg"
                id="memory-sort-arrow-down"
                viewBox="0 0 24 24"
            >
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="16" y1="15" x2="12" y2="19" />
                <line x1="8" y1="15" x2="12" y2="19" />
            </svg>`,setHTML("memory-sort-arrow",e)}},reverseMemory=()=>{global.state.sortedPapers.reverse(),global.state.papersList.reverse()},searchMemory=e=>{var a=e.toLowerCase().split(" "),o=[],i=["title","author","note","tags","id","venue"];for(let t of global.state.sortedPapers){let e=i.map(e=>Array.isArray(t[e])?t[e].join(" ").toLowerCase():"string"==typeof t[e]?t[e].toLowerCase():(logError("searchMemory: non-string & non-array content for key "+e),log(t),""));!a.every(t=>e.some(e=>e.includes(t)))||global.state.showFavorites&&!t.favorite||o.push(t)}global.state.papersList=o},searchMemoryByYear=e=>{var a,t=e.includes("<")?"smaller":e.includes(">")?"greater":"",o=e.replace("y:","").replace(/(<|>)/g,"").toLowerCase().replaceAll(","," ").split(" ").filter(e=>0<e.length).map(e=>4===e.length?e:"20"+e).map(e=>parseInt(e,10)),i=(console.log("searchYears: ",o),[]);let r=(e,t)=>e===t;"smaller"==t?r=(e,t)=>t<e:"greater"==t&&(r=(e,t)=>e<t);for(a of global.state.sortedPapers){let t=parseInt(a.year,10);o.some(e=>r(e,t))&&i.push(a)}global.state.papersList=i},searchMemoryByTags=e=>{var t,a=e.replace("t:","").toLowerCase().split(" "),o=[];for(t of global.state.sortedPapers){let e=t.tags.map(e=>e.toLowerCase());!a.every(t=>e.some(e=>0<=e.indexOf(t)))||global.state.showFavorites&&!t.favorite||o.push(t)}global.state.papersList=o},searchMemoryByCode=e=>{var a,o=e.replace("c:","").toLowerCase().split(" "),i=[];for(a of global.state.sortedPapers){let t=a.codeLink||"";t=t.toLowerCase(),!o.every(e=>t.includes(e))||global.state.showFavorites&&!a.favorite||i.push(a)}global.state.papersList=i},updatePaperTagsHTML=e=>{setHTML(findEl({paperId:e,memoryItemClass:"tag-list"}),global.state.papers[e].tags.map(e=>`<span class="memory-tag">${e}</span>`).join(""))},updateTagOptions=e=>{updateAllMemoryPaperTagOptions();var t=getTagsOptions(global.state.papers[e]);setHTML("popup-item-tags--"+e,t)},updatePaperTags=(t,e)=>{let a;a=e.startsWith("#")?findEl({element:e.replace("#","")}):findEl({paperId:t,memoryItemClass:e});e=parseTags(a);let o=!1;new Set;arraysIdentical(global.state.papers[t].tags,e)||(o=!0),global.state.papers[t].tags=e,o&&chrome.storage.local.set({papers:global.state.papers},()=>{var e;makeTags(),updateTagOptions(t),updatePaperTagsHTML(t);for(e of queryAll(".memory-tag",findEl({paperId:t,memoryItemClass:"tag-list"})))addListener(e,"click",handleTagClick)})},displayOnScroll=i=>delay(()=>{let e=null!==document.getElementById("papers-table-body");var t=e?document.getElementById("papers-table-body"):findEl({element:"memory-table"});if(t){var t=t.getBoundingClientRect().bottom,a=i?findEl({element:"memory-container"}).getBoundingClientRect().height:window.innerHeight,o=global.state.currentMemoryPagination*global.state.memoryItemsPerPage;if(Math.abs(t-a)<a&&o<global.state.papersList.length){global.state.currentMemoryPagination+=1;let e=null!==document.getElementById("papers-table-body");(e?displayMemoryTableView:displayMemoryTable)(global.state.currentMemoryPagination)}}},50),displayMemoryTable=(e=0)=>{var t,a=Date.now(),o=findEl({element:"memory-table"}),i=(0===e&&(setHTML(o,""),global.state.currentMemoryPagination=0),[]);for(t of global.state.papersList.slice(e*global.state.memoryItemsPerPage,(e+1)*global.state.memoryItemsPerPage))try{i.push(getMemoryItemHTML(t))}catch(e){log("displayMemoryTable error:"),log(e),log(t)}0===e?setHTML(o,i.join("")):o.insertAdjacentHTML("beforeend",i.join("")),addEventToClass(".back-to-focus","click",handleBackToFocus),addEventToClass(".memory-delete","click",handleDeleteItem),addEventToClass(".memory-item-link","click",handleOpenItemLink),addEventToClass(".memory-item-scirate","click",handleOpenItemScirate),addEventToClass(".memory-item-alphaxiv","click",handleOpenItemAlphaxiv),addEventToClass(".memory-item-ar5iv","click",handleOpenItemAr5iv),addEventToClass(".memory-item-huggingface","click",handleOpenItemHuggingface),addEventToClass(".memory-code-link","click",handleOpenItemCodeLink),addEventToClass(".memory-website-url","click",handleOpenItemWebsiteURL),addEventToClass(".memory-item-md","click",handleCopyMarkdownLink),addEventToClass(".memory-item-bibtex","click",handleCopyBibtex),addEventToClass(".memory-item-copy-link","click",handleCopyPDFLink),addEventToClass(".memory-item-copy-hyperlink","click",handleCopyHyperLink),addEventToClass(".memory-item-openLocal","click",handleMemoryOpenLocal),addEventToClass(".memory-item-favorite","click",handleAddItemToFavorites),addEventToClass(".cancel-note-form","click",handleCancelPaperEdit),addEventToClass(".memory-item-edit","click",handleTogglePaperEdit),addEventToClass(".memory-tag","click",handleTagClick),setFormChangeListener(void 0,!1),addEventToClass(".memory-display-id","click",getHandleTitleTooltip(showTitleTooltip,0)),addEventToClass(".memory-display-id","mouseleave",getHandleTitleTooltip(hideTitleTooltip,1e4)),addEventToClass(".expand-paper-authors","click",handleExpandAuthors),addEventToClass(".form-note-textarea","focus",handleTextareaFocus);e=Date.now();info("Display duration (s): "+(e-a)/1e3)},displayMemoryTableView=(e=0)=>{var t=Date.now(),a=document.getElementById("papers-table-body");if(!a)return displayMemoryTable(e);if(0===e&&(a.innerHTML="",global.state.currentMemoryPagination=0),0===global.state.papersList.length)0===e&&showTableEmptyState();else{var o,i=[];for(o of global.state.papersList.slice(e*global.state.memoryItemsPerPage,(e+1)*global.state.memoryItemsPerPage))try{i.push(getMemoryTableRowHTML(o))}catch(e){log("displayMemoryTableView error:"),log(e),log(o)}0===e?a.innerHTML=i.join(""):a.insertAdjacentHTML("beforeend",i.join("")),addTableEventListeners();e=Date.now();info("Table display duration (s): "+(e-t)/1e3)}},addTableEventListeners=()=>{addEventToClass(".favorite-star","click",handleToggleFavoriteTable),addEventToClass(".paper-title","click",handleOpenPaperTable),addEventToClass(".tag-badge","click",handleTagClickTable),addEventToClass(".copy-md","click",handleCopyMarkdownTable),addEventToClass(".copy-bibtex","click",handleCopyBibtexTable),addEventToClass(".open-paper","click",handleOpenPaperTable),addEventToClass(".editable-tags","blur",handleTagsEditTable),addEventToClass(".editable-tags","keydown",handleTagsKeydownTable),addEventToClass(".editable-note","blur",handleNoteEditTable),addEventToClass(".editable-note","keydown",handleNoteKeydownTable)},handleToggleFavoriteTable=async e=>{var t=e.target.dataset.paperId;t&&global.state.papers[t]&&((t=global.state.papers[t]).favorite=!t.favorite,e.target.classList.toggle("active",t.favorite),await setStorage("papers",global.state.papers),await pushToRemote())},handleOpenPaperTable=async e=>{var t,e=e.target.dataset.paperId;e&&global.state.papers[e]&&(e=global.state.papers[e],t=(global.state.prefs.checkPreferPdf?paperToPDF:paperToAbs)(e),e.count=(e.count||0)+1,e.lastOpenDate=(new Date).toISOString(),await setStorage("papers",global.state.papers),await pushToRemote(),window.open(t,"_blank"))},handleTagClickTable=e=>{var t,e=e.target.dataset.tag;e&&(t=document.getElementById("memory-search"))&&(t.value="t:"+e,t.dispatchEvent(new Event("keypress")))},handleCopyMarkdownTable=async e=>{var t=e.target.dataset.paperId;if(t&&global.state.papers[t]){t=global.state.papers[t],t=makeMdLink(t,global.state.prefs);try{await navigator.clipboard.writeText(t),showTableFeedback(e.target,"Markdown copied!")}catch(e){console.error("Failed to copy:",e)}}},handleCopyBibtexTable=async e=>{var t=e.target.dataset.paperId;if(t&&global.state.papers[t]){var t=global.state.papers[t],a=t.bibtex,o=bibtexToObject(a);o.hasOwnProperty("url")||(o.url=paperToAbs(t)),o.hasOwnProperty("pdf")||(o.pdf=paperToPDF(t)),a=bibtexToString(o);try{await navigator.clipboard.writeText(a),showTableFeedback(e.target,"BibTeX copied!")}catch(e){console.error("Failed to copy:",e)}}},handleTagsEditTable=async e=>{var t=e.target.dataset.paperId,a=e.target.value.trim(),o=e.target.dataset.originalValue;t&&a!==o&&(o=global.state.papers[t])&&(t=a?a.split(",").map(e=>e.trim()).filter(e=>e):[],o.tags=t,e.target.dataset.originalValue=a,await setStorage("papers",global.state.papers),await pushToRemote(),showTableFeedback(e.target,"Tags updated!"))},handleTagsKeydownTable=e=>{"Enter"===e.key?e.target.blur():"Escape"===e.key&&(e.target.value=e.target.dataset.originalValue,e.target.blur())},handleNoteEditTable=async e=>{var t=e.target.dataset.paperId,a=e.target.value.trim(),o=e.target.dataset.originalValue;t&&a!==o&&(o=global.state.papers[t])&&(o.note=a,e.target.dataset.originalValue=a,await setStorage("papers",global.state.papers),await pushToRemote(),showTableFeedback(e.target,"Note updated!"))},handleNoteKeydownTable=e=>{"Enter"===e.key&&e.ctrlKey?e.target.blur():"Escape"===e.key&&(e.target.value=e.target.dataset.originalValue,e.target.blur())},showTableFeedback=(e,t)=>{let a=document.createElement("div");a.textContent=t,a.style.cssText=`
        position: absolute;
        background: var(--success-color, #28a745);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        z-index: 1000;
        pointer-events: none;
    `;t=e.getBoundingClientRect();a.style.left=t.left+"px",a.style.top=t.top-30+"px",document.body.appendChild(a),setTimeout(()=>{document.body.removeChild(a)},2e3)},showTableEmptyState=()=>{var e=document.getElementById("papers-table-body");e&&(e.innerHTML=`
        <tr>
            <td colspan="8" class="table-empty">
                <h3>No papers found</h3>
                <p>Try adjusting your search terms or filters.</p>
            </td>
        </tr>
    `)},showTableLoadingState=()=>{var e=document.getElementById("papers-table-body");e&&(e.innerHTML=`
        <tr>
            <td colspan="8" class="table-loading">
                <div class="pm-loader" style="width: 32px; height: 32px; margin: 0 auto 16px;"></div>
                Loading papers...
            </td>
        </tr>
    `)},makeMemoryHTML=async()=>{setPlaceholder("memory-search",`Search ${global.state.papersList.length} entries ...`),(null!==document.getElementById("papers-table-body")?displayMemoryTableView:displayMemoryTable)();let e=300;global.state.papersList.length<20?e=0:global.state.papersList.length<100&&(e=150),addListener("memory-search","keypress",delay(handleMemorySearchKeyPress(),e)),addListener("memory-search","clear-search",handleMemorySearchKeyPress(!0)),addListener("memory-search","keyup",handleMemorySearchKeyUp),addListener("delete-paper-modal-cancel-button","click",handleCancelModalClick),addListener("delete-paper-modal-confirm-button","click",handleConfirmDeleteModalClick),addListener("filter-favorites","click",handleFilterFavorites),addListener("memory-select","change",handleMemorySelectChange),addListener("memory-sort-arrow","click",handleMemorySortArrow),addListener("memory-container","scroll",displayOnScroll(!0))},openMemory=()=>{global.state.prefsIsOpen&&closeMenu(),global.state.memoryIsOpen=!0,hideId("memory-switch-open"),showId("memory-switch-close"),hideId("menu-switch"),dispatch("memory-switch","blur"),slideDown("memory-container",200,()=>{setTimeout(()=>{dispatch("memory-search","focus")},100)}),setTimeout(()=>{addListener("memory-search-clear-icon","click",handleClearSearch),val("memory-select","lastOpenDate"),setMemorySortArrow("down")},200)},closeMemory=()=>{dispatch("memory-switch","blur"),hideId("memory-switch-close"),showId("memory-switch-open"),slideUp("memory-container",200,()=>{val("memory-search",""),dispatch("memory-search","clear-search"),global.state.memoryIsOpen=!1,global.state.showFavorites&&dispatch("filter-favorites","click"),showId("menu-switch","flex")})},ANKI_CONNECT_URL="http://localhost:8765";async function ankiRequest(e,t={}){e={action:e,version:6,params:t};try{var a=await fetch(ANKI_CONNECT_URL,{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(5e3)});if(!a.ok)throw new Error("HTTP error! status: "+a.status);var o=await a.json();if(o.error)throw new Error(o.error);return o.result}catch(e){throw console.error("AnkiConnect request failed:",e),e}}async function isAnkiConnectAvailable(){try{return await ankiRequest("version"),!0}catch(e){return console.error("AnkiConnect not available:",e),!1}}async function getAnkiConnectVersion(){return ankiRequest("version")}async function getDeckNames(){return ankiRequest("deckNames")}async function createDeck(e){return ankiRequest("createDeck",{deck:e})}async function ensureArxivDeck(){(await getDeckNames()).includes("arxiv")||(await createDeck("arxiv"),console.log("Created arxiv deck"))}async function addAnkiCard(e,t,a,o=[]){return"arxiv"===e&&await ensureArxivDeck(),ankiRequest("addNote",{note:{deckName:e,modelName:"Basic",fields:{Front:t,Back:a},tags:o,options:{allowDuplicate:!0,duplicateScope:"deck"}}})}async function getAnkiStatus(){try{var e=await getAnkiConnectVersion(),t=await getDeckNames(),a=t.includes("arxiv");return{available:!0,version:e,deckCount:t.length,hasArxivDeck:a,decks:t}}catch(e){return{available:!1,error:e.message}}}let ankiViewState={isOpen:!1,currentPaper:null,capturedImage:null};function toggleAnkiView(){var e;console.log("Toggle Anki view called, current state:",ankiViewState.isOpen),ankiViewState.isOpen?closeAnkiView():(e=getCurrentPaper())?openAnkiView(e):showAnkiStatus("No paper found. Please open a paper first.","error")}async function openAnkiView(a){console.log("Opening Anki view for paper:",a);try{if(await isAnkiConnectAvailable()){ankiViewState.currentPaper=a,ankiViewState.isOpen=!0,document.documentElement.classList.add("anki-active"),document.body.classList.add("anki-active");let e=document.getElementById("anki-side-panel"),t=document.getElementById("popup-container");var o=document.getElementById("anki-side-content");e&&o?(o.innerHTML=createAnkiFormContent(a),e.style.display="block",setTimeout(()=>{e.classList.add("open"),t.classList.add("anki-open")},10),setupAnkiEventListeners(),setTimeout(()=>{var e=document.getElementById("anki-question");e&&e.focus()},300),console.log("Anki view opened successfully")):console.error("Anki side panel elements not found")}else showAnkiStatus("AnkiConnect is not available. Please make sure Anki is running with AnkiConnect installed.","error")}catch(e){console.error("Failed to open Anki view:",e),showAnkiStatus("Failed to open Anki view: "+e.message,"error")}}function closeAnkiView(){console.log("Closing Anki view"),ankiViewState.isOpen=!1,ankiViewState.currentPaper=null,ankiViewState.capturedImage=null,document.documentElement.classList.remove("anki-active"),document.body.classList.remove("anki-active");let e=document.getElementById("anki-side-panel");var t=document.getElementById("popup-container");e&&(e.classList.remove("open"),t.classList.remove("anki-open"),setTimeout(()=>{e.style.display="none"},300))}function createAnkiFormContent(e){var t=createShortPaperMetadata(e);return`
        <div class="anki-paper-info">
            <h3>${e.title||"Unknown Title"}</h3>
            <p><strong>Authors:</strong> ${e.author||e.authors||"Unknown"}</p>
            <div class="anki-short-metadata">${t}</div>
        </div>
        
        <div class="anki-card-form">
            <div class="anki-field-group">
                <label for="anki-question">Question/Front</label>
                <div class="anki-question-container">
                    <div class="anki-capture-area" id="anki-capture-area">
                        <div class="anki-capture-placeholder" id="anki-capture-placeholder">
                            <p>Add a screenshot to your Anki card</p>
                            <button type="button" id="anki-capture-btn">Capture Screen</button>
                        </div>
                        <canvas id="anki-capture-canvas" style="display: none;"></canvas>
                    </div>
                    <textarea id="anki-question" placeholder="Enter your question here..." rows="3"></textarea>
                </div>
            </div>
            
            <div class="anki-field-group">
                <label for="anki-answer">Answer/Back</label>
                <textarea id="anki-answer" placeholder="Enter your answer here..." rows="4"></textarea>
            </div>
            
            <div class="anki-field-group">
                <label for="anki-tags">Tags (optional)</label>
                <input type="text" id="anki-tags" placeholder="e.g., machine-learning, computer-vision" />
            </div>
            
            <div class="anki-actions">
                <button type="button" class="anki-secondary-btn" onclick="closeAnkiView()">Cancel</button>
                <button type="button" class="anki-primary-btn" id="anki-add-card-btn">Add to Anki</button>
            </div>
            
            <div id="anki-status" style="display: none;"></div>
        </div>
    `}function createShortPaperMetadata(e){var t=[],a=createShortTitle(e.title||"Unknown Title");a&&t.push(`<strong>${a}</strong>`),e.year&&t.push(e.year),e.venue&&t.push(e.venue);let o=null;return"arxiv"===e.source&&e.id?(a=arxivIdFromPaperID(e.id))&&(o="https://arxiv.org/abs/"+a):e.url?o=e.url:e.pdfLink&&(o=e.pdfLink),o&&t.push(`<a href="${o}" target="_blank">Link</a>`),0<t.length?`<small>${t.join(" • ")}</small>`:""}function createShortTitle(e){if(!e)return"";let t=e;return(t=e.includes(":")?e.split(":")[0].trim():t).split(/\s+/).slice(0,3).join(" ")}function setupAnkiEventListeners(){var e=document.getElementById("anki-side-close"),e=(e&&e.addEventListener("click",closeAnkiView),document.getElementById("anki-capture-btn")),e=(e&&e.addEventListener("click",startScreenCapture),document.getElementById("anki-add-card-btn"));e&&e.addEventListener("click",handleAddToAnki),document.addEventListener("keydown",function(e){"Escape"===e.key&&ankiViewState.isOpen&&closeAnkiView()})}async function startScreenCapture(){try{chrome.tabs.captureVisibleTab(null,{format:"png"},e=>{if(chrome.runtime.lastError)throw new Error(chrome.runtime.lastError.message);let a=new Image;a.onload=function(){var e=document.createElement("canvas"),t=e.getContext("2d");e.width=a.width,e.height=a.height,t.drawImage(a,0,0),showEnhancedCroppingInterface(e)},a.src=e})}catch(e){console.error("Screen capture failed:",e),showAnkiStatus("Screen capture failed: "+e.message,"error")}}function showEnhancedCroppingInterface(e){var t=document.getElementById("anki-side-panel"),a=document.getElementById("anki-capture-area"),o=(document.getElementById("anki-capture-placeholder").style.display="none",document.createElement("div")),a=(o.className="anki-enhanced-crop-container",o.innerHTML=`
        <div class="anki-crop-instructions">
            <h4 style="margin: 0 0 8px 0; color: var(--text);">Crop Screenshot for Anki Card</h4>
            <p style="margin: 0 0 12px 0; font-size: 0.9rem; color: var(--text-secondary);">Drag to select the area you want to include in your card</p>
            <div class="anki-crop-buttons">
                <button class="anki-crop-btn anki-crop-confirm" id="anki-use-selection-enhanced">Use Selection</button>
                <button class="anki-crop-btn anki-crop-full" id="anki-use-full-enhanced">Use Full Image</button>
                <button class="anki-crop-btn anki-crop-cancel" id="anki-crop-cancel-enhanced">Cancel</button>
            </div>
        </div>
        <div class="anki-enhanced-crop-canvas-container">
            <canvas class="anki-crop-canvas" id="anki-enhanced-crop-canvas"></canvas>
            <div class="anki-crop-overlay" id="anki-enhanced-crop-overlay"></div>
        </div>
    `,a.appendChild(o),document.getElementById("anki-enhanced-crop-canvas")),o=a.getContext("2d"),i=Math.min(1200/e.width,600/e.height,1),r=e.width*i,i=e.height*i;a.width=r,a.height=i,a.style.width=r+"px",a.style.height=i+"px",o.drawImage(e,0,0,r,i),a.dataset.scaleX=(e.width/r).toString(),a.dataset.scaleY=(e.height/i).toString(),setupEnhancedCropping(a,e,t,null,null)}function setupEnhancedCropping(r,o,e,t,a){let s=document.getElementById("anki-enhanced-crop-overlay");r.parentElement;let l=!1,n,d,p=null;function c(e){var t=r.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}r.addEventListener("mousedown",e=>{l=!0;var t=c(e);n=t.x,d=t.y,s.style.display="block",s.style.left=n+"px",s.style.top=d+"px",s.style.width="0px",s.style.height="0px",e.preventDefault(),console.log("Enhanced cropping started at:",{x:n,y:d})}),r.addEventListener("mousemove",e=>{var t,a,o,i;l&&(i=c(e),o=Math.max(0,Math.min(i.x,r.width)),i=Math.max(0,Math.min(i.y,r.height)),t=Math.min(n,o),a=Math.min(d,i),o=Math.abs(o-n),i=Math.abs(i-d),p={left:t,top:a,width:o,height:i},s.style.left=t+"px",s.style.top=a+"px",s.style.width=o+"px",s.style.height=i+"px",e.preventDefault())}),r.addEventListener("mouseup",()=>{l=!1,console.log("Enhanced cropping selection completed:",p)}),r.addEventListener("mouseleave",()=>{l=l&&!1}),setTimeout(()=>{var e=document.getElementById("anki-use-selection-enhanced"),t=document.getElementById("anki-use-full-enhanced"),a=document.getElementById("anki-crop-cancel-enhanced");e&&e.addEventListener("click",()=>{p&&10<p.width&&10<p.height?(console.log("Using selection for enhanced crop:",p),cropAndSaveImageEnhanced(o,r,p)):showAnkiStatus("Please select an area first","error")}),t&&t.addEventListener("click",()=>{cropAndSaveImageEnhanced(o,r,null)}),a&&a.addEventListener("click",()=>{document.getElementById("anki-capture-area");var e=document.getElementById("anki-capture-placeholder"),t=document.querySelector(".anki-enhanced-crop-container");t&&t.remove(),e&&(e.style.display="block")})},100)}function cropAndSaveImageEnhanced(e,t,a){var o,i,r,s,l,n=document.createElement("canvas"),d=n.getContext("2d"),a=(a?(p=parseFloat(t.dataset.scaleX)||e.width/t.width,o=parseFloat(t.dataset.scaleY)||e.height/t.height,i=a.left*p,r=a.top*o,s=a.width*p,l=a.height*o,i=Math.max(0,Math.min(i,e.width)),r=Math.max(0,Math.min(r,e.height)),s=Math.min(s,e.width-i),l=Math.min(l,e.height-r),n.width=s,n.height=l,d.drawImage(e,i,r,s,l,0,0,s,l),console.log("Cropping details:",{selection:a,scaleX:p,scaleY:o,originalCanvas:{width:e.width,height:e.height},displayCanvas:{width:t.width,height:t.height},crop:{x:i,y:r,width:s,height:l}})):(n.width=e.width,n.height=e.height,d.drawImage(e,0,0)),n.toDataURL("image/jpeg",.8)),p=(ankiViewState.capturedImage=a,document.querySelector(".anki-enhanced-crop-container"));p&&p.remove(),showCapturedImageResult(a,n)}function showCapturedImageResult(e,t){var a=document.getElementById("anki-capture-area");let o=document.getElementById("anki-capture-placeholder");o.style.display="none";var i=document.querySelector(".anki-final-result");i&&i.remove();let r=document.createElement("div");r.className="anki-final-result";i=Math.round(.75*e.length/1024);r.innerHTML=`
        <img src="${e}" class="anki-final-capture" alt="Captured image">
        <div class="anki-image-info">
            <small>Captured: ${t.width}×${t.height}px, ~${i}KB (JPEG)</small>
        </div>
        <button type="button" class="anki-secondary-btn" id="anki-remove-image-btn">Remove Image</button>
    `,a.appendChild(r),document.getElementById("anki-remove-image-btn").addEventListener("click",function(){r.remove(),o.style.display="block",ankiViewState.capturedImage=null})}function showCroppingInterface(e){var t=document.getElementById("anki-capture-area"),a=(document.getElementById("anki-capture-placeholder").style.display="none",document.createElement("div")),t=(a.className="anki-crop-container",a.innerHTML=`
        <div class="anki-crop-instructions">
            <p>Drag to select the area you want to include in your Anki card</p>
            <div class="anki-crop-buttons">
                <button class="anki-crop-btn anki-crop-confirm" id="anki-use-selection">Use Selection</button>
                <button class="anki-crop-btn anki-crop-full" id="anki-use-full">Use Full Image</button>
                <button class="anki-crop-btn anki-crop-cancel" id="anki-crop-cancel">Cancel</button>
            </div>
        </div>
        <div class="anki-crop-canvas-container">
            <canvas class="anki-crop-canvas" id="anki-crop-canvas"></canvas>
            <div class="anki-crop-overlay" id="anki-crop-overlay"></div>
        </div>
    `,t.appendChild(a),document.getElementById("anki-crop-canvas")),a=t.getContext("2d"),o=Math.min(380/e.width,200/e.height,1),i=e.width*o,o=e.height*o;t.width=i,t.height=o,t.style.width=i+"px",t.style.height=o+"px",a.drawImage(e,0,0,i,o),t.dataset.scaleX=(e.width/i).toString(),t.dataset.scaleY=(e.height/o).toString(),setupCropping(t,e)}function setupCropping(r,o){let s=document.getElementById("anki-crop-overlay"),l=!1,n,d,p=null;function c(e){var t=r.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}r.addEventListener("mousedown",e=>{l=!0;var t=c(e);n=t.x,d=t.y,s.style.display="block",s.style.left=n+"px",s.style.top=d+"px",s.style.width="0px",s.style.height="0px",e.preventDefault()}),r.addEventListener("mousemove",e=>{var t,a,o,i;l&&(i=c(e),o=Math.max(0,Math.min(i.x,r.width)),i=Math.max(0,Math.min(i.y,r.height)),t=Math.min(n,o),a=Math.min(d,i),o=Math.abs(o-n),i=Math.abs(i-d),p={left:t,top:a,width:o,height:i},s.style.left=t+"px",s.style.top=a+"px",s.style.width=o+"px",s.style.height=i+"px",e.preventDefault())}),r.addEventListener("mouseup",()=>{l=!1}),r.addEventListener("mouseleave",()=>{l=l&&!1}),setTimeout(()=>{var e=document.getElementById("anki-use-selection"),t=document.getElementById("anki-use-full"),a=document.getElementById("anki-crop-cancel");e&&e.addEventListener("click",()=>{p&&10<p.width&&10<p.height?cropAndSaveImage(o,r,p):showAnkiStatus("Please select an area first","error")}),t&&t.addEventListener("click",()=>{cropAndSaveImage(o,r,null)}),a&&a.addEventListener("click",()=>{document.getElementById("anki-capture-area");var e=document.getElementById("anki-capture-placeholder"),t=document.querySelector(".anki-crop-container");t&&t.remove(),e&&(e.style.display="block")})},100)}function cropAndSaveImage(e,t,a){var o,i,r,s,l=document.createElement("canvas"),n=l.getContext("2d"),a=(a?(d=parseFloat(t.dataset.scaleX)||e.width/t.width,p=parseFloat(t.dataset.scaleY)||e.height/t.height,o=a.left*d,i=a.top*p,r=a.width*d,s=a.height*p,o=Math.max(0,Math.min(o,e.width)),i=Math.max(0,Math.min(i,e.height)),r=Math.min(r,e.width-o),s=Math.min(s,e.height-i),l.width=r,l.height=s,n.drawImage(e,o,i,r,s,0,0,r,s),console.log("Cropping details (regular):",{selection:a,scaleX:d,scaleY:p,originalCanvas:{width:e.width,height:e.height},displayCanvas:{width:t.width,height:t.height},crop:{x:o,y:i,width:r,height:s}})):(l.width=e.width,l.height=e.height,n.drawImage(e,0,0)),l.toDataURL("image/jpeg",.8)),d=(ankiViewState.capturedImage=a,document.querySelector(".anki-crop-container")),p=(d&&d.remove(),document.getElementById("anki-capture-area"));let c=document.createElement("div");c.className="anki-final-result";t=Math.round(.75*a.length/1024);c.innerHTML=`
        <img src="${a}" class="anki-final-capture" alt="Captured image">
        <div class="anki-image-info">
            <small>Captured: ${l.width}×${l.height}px, ~${t}KB (JPEG)</small>
        </div>
        <button type="button" class="anki-secondary-btn" id="anki-remove-image-btn-popup">Remove Image</button>
    `,p.appendChild(c),document.getElementById("anki-remove-image-btn-popup").addEventListener("click",function(){c.remove();var e=document.getElementById("anki-capture-placeholder");e&&(e.style.display="block"),ankiViewState.capturedImage=null}),console.log(`Image cropped and compressed successfully: ${l.width}×${l.height}px, ~${t}KB`),showAnkiStatus("Image captured and compressed successfully!","success")}async function handleAddToAnki(){var t=document.getElementById("anki-question").value.trim(),a=document.getElementById("anki-answer").value.trim(),o=document.getElementById("anki-tags").value.trim();if(t||ankiViewState.capturedImage)if(a)try{showAnkiStatus("Adding card to Anki...","info");let e="";var i=createShortPaperMetadata(ankiViewState.currentPaper),r=(i&&(e+=i+"<br><br>"),ankiViewState.capturedImage&&(e+=`<img src="${ankiViewState.capturedImage}"><br><br>`),t&&(e+=t),o?o.split(",").map(e=>e.trim()).filter(e=>e):[]);r.push("arxiv","papermemory"),await addAnkiCard("arxiv",e,a,r),showAnkiStatus("Card added to Anki successfully!","success"),setTimeout(()=>{closeAnkiView()},1500)}catch(e){console.error("Failed to add card to Anki:",e),showAnkiStatus("Failed to add card to Anki: "+e.message,"error")}else showAnkiStatus("Please add an answer","error");else showAnkiStatus("Please add either a question or capture an image","error")}function showAnkiStatus(e,t){let a=document.getElementById("anki-status");a&&(a.textContent=e,a.className="anki-status-message anki-status-"+t,a.style.display="block","success"===t)&&setTimeout(()=>{a.style.display="none"},3e3)}function getCurrentPaper(){var e,t;return"undefined"!=typeof currentPaper&&currentPaper?currentPaper:"undefined"!=typeof paper&&paper?paper:(e=document.getElementById("popup-paper-title"),t=document.getElementById("popup-authors"),e&&e.textContent?{title:e.textContent,authors:t?t.textContent.replace("Authors: ",""):"Unknown",source:"arxiv",year:(new Date).getFullYear()}:null)}document.addEventListener("keydown",function(e){(e.ctrlKey||e.metaKey)&&"k"===e.key&&(e.preventDefault(),toggleAnkiView())});let closeMenu=()=>{slideUp("menu-container",300),setHTML("menu-switch",tablerSvg("settings","menu-switch-svg",["pm-tabler-icon","menu-svg"])),dispatch("menu-switch","blur"),global.state.prefsIsOpen=!1},openMenu=()=>{slideDown("menu-container",300),dispatch("menu-switch","blur"),setHTML("menu-switch",tablerSvg("circle-x","close-menu-btn",["pm-tabler-icon","menu-svg"])),global.state.prefsIsOpen=!0,setHTML("pm-version",chrome.runtime.getManifest().version),findEl({element:"menu-feedback-header"}).focus()},getAndTrackPopupMenuChecks=(e,t)=>{var a,o,i={};for(a of t){i[a]=e.hasOwnProperty(a)?e[a]:!(0<=global.prefsCheckDefaultFalse.indexOf(a));var r=findEl({element:a});r&&(r.checked=i[a])}setStorage("prefs",i);for(o of t)addListener(o,"change",handlePrefsCheckChange)},showPopupModal=e=>{global.state.modalIsOpen=!0,queryAll(".popup-modal-content").forEach(hideId),showId(`modal-${e}-content`,"contents"),style("popup-modal-wrapper","display","flex"),[...document.getElementsByTagName("a")].forEach(e=>{addListener(e,"click",()=>{chrome.tabs.create({url:e.getAttribute("href")})})})},fillUserGuideShortcuts=()=>{var e,t=findEl({element:"user-guide-shortcuts-ul"});for(e of findEl({element:"menu-keyboard-shortcuts"}).children){var a=e.querySelector("code")?.textContent;"e"!==a&&"backspace"!==a?.toLowerCase()&&("P"===e.nodeName&&(e.style.fontSize="0.9rem",e.innerText='The following keys are available when enabled in the "User Interface" section of the Menu:',e.style.marginBottom="3px",e.style.marginTop="3px",e.style.marginLeft="-14px"),t.innerHTML+=e.outerHTML)}},closePopupModal=()=>{global.state.modalIsOpen=!1,style("popup-modal-wrapper","display","none")},hideAllTooltips=()=>{queryAll(".title-tooltip,#popup-title-tooltip").forEach(e=>{hideId(e)}),global.state.tooltipIsOpen=!1},setStandardPopupClicks=()=>{queryAll(".link-in-new-tab").forEach(e=>{addListener(e,"click",()=>{chrome.tabs.create({url:e.getAttribute("href")})})}),addListener("whats-new-container","click",()=>{chrome.storage.local.get("whatsnew",({whatsnew:e})=>{var t=chrome.runtime.getManifest().version;(e=void 0===e?{}:e).hasOwnProperty(t)||hideId("whats-new-marker"),chrome.storage.local.set({whatsnew:{...e,[t]:!0}}),showPopupModal("whatsnew")})}),addListener("keyboardShortcuts","click",()=>{showPopupModal("keyboard")}),addListener("keyboardShortcutsMenu","click",()=>{showPopupModal("keyboard")}),shouldWarn("pdf-title",e=>{e&&(showId("warning-button"),addListener("warning-button","click",async()=>{showPopupModal("warning-pdf-title");var e=await getStorage("userWarnings")??{};e["pdf-title"]=!0,setStorage("userWarnings",e),hideId("warning-button")}))}),addListener("close-popup-modal","click",closePopupModal),addListener(window,"click",e=>{e.target===findEl({element:"popup-modal-wrapper"})&&closePopupModal()}),addListener("menu-switch","click",()=>{(global.state.prefsIsOpen?closeMenu:openMenu)()}),addListener("memory-switch","click",handleMemorySwitchClick)},editManualWebsite=(p,c)=>{hideId("manual-website-validation"),showPopupModal("manual-website"),showId("website-trigger-btn");var e;for(e of["author","title","year","url","note","pdfLink"])findEl({element:"manual-website-"+e}).value=p[e]??"";setHTML("manual-website-url",p.codeLink),addListener("manual-website-form","submit",async e=>{e.preventDefault(),hideId("manual-website-validation");e=val("manual-website-title");let t=val("manual-website-author");var a,o=val("manual-website-year"),i=val("manual-website-note"),r=val("manual-website-pdfLink"),i=(t.includes(",")&&(t=t.split(",").map(e=>e.trim()).join(" and ")),{...p,title:e,author:t,year:o,note:i,pdfLink:r}),s=""+miniHash(t.split(" and ")[0].split(" ").last())+o+firstNonStopLowercase(e),{warnings:l,paper:o}=(i.bibtex=bibtexToString({...bibtexToObject(i.bibtex),author:t,year:o,title:e,citationKey:s,url:r}),validatePaper(i));let n="";for(a of Object.keys(l))for(var d of l[a])n+=`<li>${d}</li>`;return 0<n.length?(n=`<ul>${n}</ul>`,setHTML("manual-website-validation",n),showId("manual-website-validation")):(global.state.papers[o.id]=o,await setStorage("papers",global.state.papers),await pushToRemote(),popupMain(c,await isPaper(c),!0,null),hideId("website-trigger-btn"),hideId("notArxiv"),closePopupModal()),!1})},popupMain=async(o,t,i=!1,a=null)=>{console.log(navigator.userAgent),"PuppeteerAgent"===navigator.userAgent&&info("Is puppet"),addListener(document,"keydown",handlePopupKeydown),chrome.storage.local.get("whatsnew",({whatsnew:e})=>{var t=chrome.runtime.getManifest().version;e&&e.hasOwnProperty(t)||showId("whats-new-marker")}),console.log("manualTrigger: ",i),(i?(hideId("memory-switch"),showId("memory-spinner"),await initSyncAndState({forceInit:!0}),hideId("memory-spinner"),showId("memory-switch"),makeMemoryHTML):setStandardPopupClicks)();let s=await getPrefs();getAndTrackPopupMenuChecks(s,global.prefsCheckNames);i=await getDefaultKeyboardAction();if(findEl({element:"memory-item-default-action"}).value=i,addListener("advanced-configuration","click",()=>{chrome.runtime.openOptionsPage()}),addListener("full-memory","click",()=>{chrome.tabs.create({url:chrome.runtime.getURL("src/fullMemory/fullMemory.html")})}),addListener("bib-matcher","click",()=>{chrome.tabs.create({url:chrome.runtime.getURL("src/bibMatcher/bibMatcher.html")})}),addListener("memory-item-default-action","change",e=>{setDefaultKeyboardAction(e.target.value)}),fillUserGuideShortcuts(),Object.values(t).some(e=>e)){setTimeout(()=>{document.body.style.height="auto",document.body.style.minHeight="450px"},0),showId("isArxiv","flex");let a=await parseIdFromUrl(o);if((global.state.currentId=a)&&global.state.papers.hasOwnProperty(a)){let r=global.state.papers[a];var l,i=r.id.replaceAll(".","\\.");setHTML("popup-paper-title",r.title.replaceAll("\n","")+'<div id="popup-title-tooltip" style="display: none;">'),setHTML("popup-authors",cutAuthors(r.author,200).replace(/({|})/g,"")),r.codeLink&&(setTextId("popup-code-link",r.codeLink.replace(/^https?:\/\//,"")),showId("popup-code-link")),"website"===r.source&&(setTextId("popup-website-url",r.pdfLink.replace(/^https?:\/\//,"")),showId("popup-website-url")),log("Popup paper:",r),setHTML("popup-memory-edit",getPopupEditFormHTML(r)),setHTML("popup-copy-icons",getPopupPaperIconsHTML(r,o,t)),setHTML("popup-title-tooltip",getPaperInfoTable(r)),findEl({element:"checkFavorite--"+a}).checked=r.favorite;let e=0;for(l of["checkScirate","checkAlphaxiv","checkAr5iv","checkHuggingface"])s[l]&&(e+=5);style("popup-icons-container","width",75+e+"%"),$("#popup-item-tags--"+i).select2({...global.select2Options,width:"87%"}),addListener("popup-form-note-textarea--"+a,"focus",()=>{textareaFocusEnd(this)}),setFormChangeListener(a,!0),addListener("popup-delete-paper","click",handlePopupDeletePaper(a)),addEventToClass(".popup-display-id","click",getHandleTitleTooltip(showTitleTooltip,0,!0)),addEventToClass(".popup-display-id","mouseleave",getHandleTitleTooltip(hideTitleTooltip,1e4,!0)),addEventToClass(".expand-paper-authors","click",handleExpandAuthors),addListener("popup-memory-item-scirate--"+a,"click",()=>{var e=arxivIdFromPaperID(r.id);chrome.tabs.update({url:"https://scirate.com/arxiv/"+e}),window.close()}),addListener("popup-memory-item-alphaxiv--"+a,"click",()=>{var e=arxivIdFromPaperID(r.id);chrome.tabs.update({url:"https://alphaxiv.org/abs/"+e}),window.close()}),addListener("popup-memory-item-ar5iv--"+a,"click",()=>{let t=arxivIdFromPaperID(r.id);var e=2e3+parseInt(t.split(".")[0].slice(0,2),10),a=parseInt(t.split(".")[0].slice(-2),10),o=(new Date).getFullYear(),i=(new Date).getMonth()+1;e===o&&a===i?(showPopupModal("ar5iv"),addListener("ar5iv-modal-ok-button","click",()=>{var e="https://ar5iv.labs.arxiv.org/html/"+t;chrome.tabs.update({url:e}),window.close()}),addListener("ar5iv-modal-cancel-button","click",closePopupModal)):(e="https://ar5iv.labs.arxiv.org/html/"+t,chrome.tabs.update({url:e}),window.close())}),addListener("popup-memory-item-huggingface--"+a,"click",()=>{var e=arxivIdFromPaperID(r.id);chrome.tabs.update({url:"https://huggingface.co/papers/"+e}),window.close()}),addListener("popup-memory-item-link--"+a,"click",()=>{var e=paperToPDF(r),t=paperToAbs(r);chrome.tabs.update({url:isPdfUrl(o)?t:e}),window.close()}),addListener("popup-code-link","click",async()=>{var e=findEl({element:"popup-code-link"}).textContent;e&&(await focusExistingOrCreateNewURLTab(e),global.close)&&global.close()}),addListener("popup-website-url","click",async e=>{var t=findEl({element:"popup-website-url"}).textContent;t&&await focusExistingOrCreateNewURLTab(t)}),addListener("popup-memory-item-copy-link--"+a,"click",async()=>{var e=(s.checkPreferPdf?paperToPDF:paperToAbs)(r),t="website"===r.source?"URL":s.checkPreferPdf?"PDF":"Abstract";await copyAndConfirmMemoryItem({id:a,textToCopy:e,feedbackText:t+" link copied!",context:"popup"})}),addListener("popup-memory-item-copy-hyperlink--"+a,"click",async()=>{var e=(s.checkPreferPdf?paperToPDF:paperToAbs)(r),t="website"===r.source?"URL":s.checkPreferPdf?"PDF":"Abstract";await copyAndConfirmMemoryItem({id:a,textToCopy:e,feedbackText:t+" hyperlink copied!",context:"popup",hyperLinkTitle:r.title})}),addListener("popup-memory-item-md--"+a,"click",async()=>{var e=makeMdLink(r,s),t="website"===r.source?"URL":s.checkPreferPdf?"PDF":"Abstract";await copyAndConfirmMemoryItem({id:a,textToCopy:e,feedbackText:`Markdown ${t} copied!`,context:"popup"})}),addListener("popup-memory-item-bibtex--"+a,"click",async()=>{var e=global.state.papers[a].bibtex,t=bibtexToObject(e);t.hasOwnProperty("url")||(t.url=paperToAbs(global.state.papers[a])),t.hasOwnProperty("pdf")||(t.pdf=paperToPDF(global.state.papers[a])),e=bibtexToString(t),await copyAndConfirmMemoryItem({id:a,textToCopy:e,feedbackText:"Bibtex citation copied!",context:"popup"})}),addListener("popup-memory-item-anki--"+a,"click",async()=>{window.currentPaper=global.state.papers[a],toggleAnkiView()}),addListener("popup-memory-item-openLocal--"+a,"click",async()=>{var e=await findLocalFile(r)||global.state.files[r.id];e?chrome.downloads.open(e.id):chrome.tabs.create({url:r.pdfLink})}),addListener("popup-memory-item-download--"+a,"click",async()=>{downloadPaperPdf(r)})}else log("Unknown id "+a),await updatePopupPaperNoMemory(o),s.checkDirectOpen&&!s.checkNoAuto&&dispatch("memory-switch","click")}else s.checkDirectOpen&&dispatch("memory-switch","click"),a&&global.state.prefs.checkWebsiteParsing&&(setHTML("website-parsing-root",`
                <div id="website-trigger-wrapper">
                    <div id="website-trigger-btn">Parse current website</div>
                    <div id="website-loader-container" class="pm-container" style='display: none;'>
                        <div class="sk-folding-cube">
                            <div class="sk-cube1 sk-cube"></div>
                            <div class="sk-cube2 sk-cube"></div>
                            <div class="sk-cube4 sk-cube"></div>
                            <div class="sk-cube3 sk-cube"></div>
                        </div>
                    </div>
                    <div id="website-parsing-error"></div>
                </div>`),showId("website-parsing-root"),addListener("website-trigger-btn","click",async()=>{hideId("website-trigger-btn"),showId("website-loader-container"),hideId("website-parsing-error");let e;try{e=await addOrUpdatePaper({tab:a,url:a.url,store:!1})}catch(e){console.log("error: ",e),hideId("website-loader-container"),showId("website-parsing-error"),setHTML("website-parsing-error",`<h3>Error</h3><div>${e}</div>`),setTimeout(()=>{hideId("website-loader-container"),hideId("website-parsing-error"),showId("website-trigger-btn")},3e3)}e?.paper&&editManualWebsite(e.paper,o)}))};async function initAnkiStatus(){try{var t=await getAnkiStatus();let e=document.getElementById("anki-status-display");var a=document.getElementById("anki-status-text");e&&a&&(t.available?(a.textContent=`Anki: Connected (v${t.version}, ${t.deckCount} decks${t.hasArxivDeck?", arxiv ✓":""})`,a.style.color="var(--success)"):(a.textContent=`Anki: Disconnected (${t.error||"AnkiConnect not running"})`,a.style.color="var(--error)"),e.style.display="block",setTimeout(()=>{e.style.display="none"},5e3))}catch(e){console.error("Failed to initialize Anki status:",e)}}let query={active:!0,lastFocusedWindow:!0};window.location.href.includes("popup")&&chrome.tabs.query(query,async e=>{chrome.runtime.connect({name:"PaperMemoryPopupSync"});var t=e[0].url;document.addEventListener("click",handleHideAllTitleTooltips);let a,o;o=new Promise(t=>{a=new Promise(e=>{initSyncAndState({stateIsReady:e,remoteIsReady:t})})}),await a;var i=await isPaper(t);Object.values(i).some(e=>e)||showId("notArxiv"),hideId("memory-spinner"),showId("memory-switch"),makeMemoryHTML(),popupMain(t,i,!1,e[0]),-1<navigator.userAgent.search("Firefox")&&hideId("overwrite-container"),await o,initAnkiStatus().catch(e=>{console.error("Anki status initialization failed:",e)}),global.state.currentId&&!global.state.papers[global.state.currentId]&&(global.state.currentId=null,makeMemoryHTML(),await updatePopupPaperNoMemory(t))});